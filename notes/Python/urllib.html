<html>
<head>
  <title>urllib</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604043 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="579"/>
<h1>urllib</h1>

<div>
<span><div><div><span><span style="font-family: georgia, palatina, serif;">使用GET请求思路</span>：</span></div><span style="font-family: georgia, palatina, serif;"> </span><ol><li><span style="font-family: georgia, palatina, serif;">构建对应的url地址，该地址包含get请求的字段名和字段内容等信息</span></li><li><span style="font-family: georgia, palatina, serif;">以对应的url为参数，构建Request对象——这一步是必须的吗？</span></li><li><span style="font-family: georgia, palatina, serif;">通过urlopen打开Request对象</span></li><li><span style="font-family: georgia, palatina, serif;">urlopen返回的对象包含要请求页面的内容，根据返回后的对象进行后续操作</span></li></ol><div><span><span style="font-family: georgia, palatina, serif;">使用POST请求思路</span>：</span></div><span style="font-family: georgia, palatina, serif;"> </span><ol><li><span style="font-family: georgia, palatina, serif;">设置好URL地址</span></li><li><span style="font-family: georgia, palatina, serif;">构建表单数据，并使用urllib.parse.urlencode对数据进行编码处理</span></li><li><span style="font-family: georgia, palatina, serif;">构建Request对象，参数包含URL地址和要传递的数据</span></li><li><span style="font-family: georgia, palatina, serif;">使用add_header()将添加头信息</span></li><li><span style="font-family: georgia, palatina, serif;">使用urllib.reqeust.urlopen()打开对应的Request对象</span></li><li><span style="font-family: georgia, palatina, serif;">后续处理</span></li></ol><div><span style="font-family: georgia, palatina, serif;">Cookie处理流程</span>：<span style="font-family: georgia, palatina, serif;">登陆需要</span></div><span style="font-family: georgia, palatina, serif;"> </span><ol><li><span style="font-family: georgia, palatina, serif;">导入Cookie处理模块http.cookiejar</span></li><li><span style="font-family: georgia, palatina, serif;">使用http.cookiejar.CookieJar()创建CookieJar对象</span></li><li><span style="font-family: georgia, palatina, serif;">使用urllib.request.HTTPCookieProcessor将上一步骤的结果作为参数创建cookie处理器，并为其参数构建opener对象</span><ol><li><span style="font-family: georgia, palatina, serif;">先build_opener</span></li><li><span style="font-family: georgia, palatina, serif;">再install_opener</span></li></ol></li><li><span style="font-family: georgia, palatina, serif;">创建全局默认的opener对象, 用opener对象代替urlopen</span></li></ol><div><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span>爬取浏览器：</span></span></span></div><div><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span>1. 模拟浏览器可以设置User-Agent信息</span></span></span></span></div><div><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span>2. 有两种让爬虫模拟成浏览器访问网页的设置方法：</span></span></span></span></span></div><ul><li><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span>方法1：使用build_opener()修改报头</span></span></span></span></span></span></li><li><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span style="font-family: georgia, palatina, serif;"><span>方法2：使用Request下的add_header()添加报头</span></span></span></span></span></span></span></li></ul><br clear="none"/></div><div><span style="font-family: georgia, palatina, serif;">分为四个部分：urllib.request；urllib.parse；urllib.error；urllib.robotparser</span></div><div><span style="font-family: georgia, palatina, serif;">一. urllib.request</span></div><div><span style="font-family: georgia, palatina, serif;">1. urllib.request.urlopen(url, data=None, [timeout,]*, ):打开一个url，可以是个字符串，也可以是一个Request对象</span></div><ul><li>参数介绍：<ul><li><span style="font-family: georgia, palatina, serif;">url：要打开的网址，可以是一个网址的字符串，也可以是一个Request对象</span></li><li><span style="font-family: georgia, palatina, serif;">data：post提交的数据</span></li><li><span style="font-family: georgia, palatina, serif;">timeout：超时时间，默认超时时间是多少？</span></li></ul></li><li><span style="font-family: georgia, palatina, serif;">返回值：这个方法总是返回一个对象，can work as context manager,返回的对象有以下方法：</span><ul><li><span style="font-family: georgia, palatina, serif;">对HTTPResponse类型数据进行操作</span><ul><li><span style="font-family: georgia, palatina, serif;">read()：读取全部内容，并赋值给一个字符串变量</span></li><li><span style="font-family: georgia, palatina, serif;">readline()：读取一行内容</span></li><li><span style="font-family: georgia, palatina, serif;">readlines()：把读取到的内容赋值给一个列表变量</span></li><li><span style="font-family: georgia, palatina, serif;">fileno()/close(): </span></li></ul></li><li><span style="font-family: georgia, palatina, serif;">geturl(): 返回获取到的resource的url</span></li><li><span style="font-family: georgia, palatina, serif;">info(): 返回HTTPMessage对象，表示远程服务器返回的头信息——<span style="color: #ff0000;">没看懂？返回与当前环境有关的信息</span></span></li><li><span style="font-family: georgia, palatina, serif;">getcode(): 返回HTTP回应的状态码</span></li></ul></li></ul><div><br clear="none"/></div><div><span style="font-family: georgia, palatina, serif;">2. urllib.request.Request(url, data=None, headers={}, )：可以包装请求，再用urlopen获取页面</span></div><ul><li><span style="font-family: georgia, palatina, serif;">参数：</span><ul><li><span style="font-family: georgia, palatina, serif;">hearder信息：</span><ul><li><span style="font-family: georgia, palatina, serif;">User-Agent ：这个头部可以携带如下几条信息：浏览器名和版本号、操作系统名和版本号、默认语言</span><br clear="none"/></li><li><span style="font-family: georgia, palatina, serif;">Referer：可以用来防止盗链，有一些网站图片显示来源http://***.com，就是检查Referer来鉴定的</span><br clear="none"/></li><li><span style="font-family: georgia, palatina, serif;">Connection：表示连接状态，记录Session的状态。</span><br clear="none"/></li></ul></li></ul></li><li><span style="font-family: georgia, palatina, serif;">Request对象：<br clear="none"/></span><ul><li><span style="font-family: georgia, palatina, serif;">add_header(key, val): 给请求添加其他信息</span></li></ul></li></ul><div><span style="font-family: georgia, palatina, serif;">3. urllib.request.build_opener([handler, ...]): 返回一个OpenerDirector的实例，手册里的其他解释不知所云。但是，如果要修改报头可以使用该方法</span></div><div><span style="font-family: georgia, palatina, serif;">4. urllib.request.install_opener(opener): </span></div><div><span style="font-family: georgia, palatina, serif;">5. urllib.request.quote(url): url只允许一部分ASCII字符如数字，字符，部分符号，其他的如汉字等不符合，此时需要使用该方法对URL编码</span></div><div><span style="font-family: georgia, palatina, serif;">6. urllib.request.unquote(url): 上方法相反，对编码的网址进行解码</span></div><div><div><span style="font-family: georgia, palatina, serif;"><br clear="none"/></span></div><div><span style="font-family: georgia, palatina, serif;">历史遗留方法，后面可能会丢弃：</span></div><span style="font-family: georgia, palatina, serif;"> </span><ul><li><span style="font-family: georgia, palatina, serif;">urllib.request.urlretrieve(<em>url</em>, <em>filename=None</em>, <em>reporthook=None</em>, <em>data=None</em>)：读出url的内容，如果有filename就会写到filename中，其他功能还没用到</span></li><li><span style="font-family: georgia, palatina, serif;">urllib.request.urlcleanup(): urlretrieve在运行时会产生一些缓存，可以使用该方法清楚这些缓存信息</span></li></ul><div><span><span style="font-family: georgia, palatina, serif;">OpenerDirector对象</span>：</span></div><span style="font-family: georgia, palatina, serif;"> </span><ul><li><span>方法：</span><ul><li><span style="font-family: georgia, palatina, serif;">add_handler(handler): </span></li><li><span style="font-family: georgia, palatina, serif;">open(url, data=None[, timeout]): </span></li></ul></li><li><span>属性：</span><ul><li><span style="font-family: georgia, palatina, serif;">handlers：</span></li><li><span style="font-family: georgia, palatina, serif;"><span>addheaders：？</span></span></li></ul></li></ul><br clear="none"/></div><div><br clear="none"/></div><div>二. <span style="font-family: georgia, palatina, serif;">urllib.parse</span></div><div><span style="font-family: georgia, palatina, serif;">1. urllib.urlencode(query, doseq=False, safe='', encoding=None, errors=None, quote_via=quote_plus): 这个方法用来编码，将一个映射或两元素元组的序列转为ASCII文本字符串，结果字符串是一系列key=value对，用&amp;分割，空格会被转为'+', '/'会被转为‘%2F’ ；如果返回的字符串要作为POST的数据使用urlopen发送，需要编码为bytes类型</span></div><div><span style="font-family: georgia, palatina, serif;"><code>2.urllib.parse.</code><code>urlparse</code>(<em>urlstring</em>, <em>scheme=''</em>, <em>allow_fragments=True</em>)：把urlstring分解成六部分</span></div><div><span style="font-family: georgia, palatina, serif;">3. urllib.parse.urlunparse():相反的作用</span></div><div><span style="font-family: georgia, palatina, serif;"><code><span style="background-color: #0078d7; color: #ffffff;">4.urllib.parse</span>.</code><code>urljoin</code>(<em>base</em>, <em>url</em>, <em>allow_fragments=True</em>)：把base和url组建成一个独立的url</span></div><div><span style="font-family: georgia, palatina, serif;">5. urllib.parse.quote</span></div><div><span style="font-family: georgia, palatina, serif;">6. urllib.parse.quote_plus</span></div><div><span style="font-family: georgia, palatina, serif;">7. urllib.parse.unquote</span></div><div><span style="font-family: georgia, palatina, serif;">8. urllib.parse.unquote_plus</span></div><div><span style="font-family: georgia, palatina, serif;"><br clear="none"/></span></div><div><div><span><span style="font-family: georgia, palatina, serif;">三. urllib.error</span>:</span></div><span style="font-family: georgia, palatina, serif;"> </span><ul><li><span style="font-family: georgia, palatina, serif;">urllib.error.URLError:是HTTPError的父类</span><ul><li><span style="font-family: georgia, palatina, serif;">触发该异常的原因：</span><ul><li><span style="font-family: georgia, palatina, serif;">连接不上服务器</span></li><li><span style="font-family: georgia, palatina, serif;">远程URL不存在</span></li><li><span style="font-family: georgia, palatina, serif;">无网络</span></li><li><span style="font-family: georgia, palatina, serif;">触发了HTTPError——这个异常是不是说明</span></li></ul></li><li><span style="font-family: georgia, palatina, serif;">方法：</span><ul><li><span style="font-family: georgia, palatina, serif;">reason：发生错误的原因</span></li></ul></li></ul></li><li><span style="font-family: georgia, palatina, serif;">urllib.error.HTTPError: 以上触发异常的原因中的前三种捕获不到</span><ul><li><span style="font-family: georgia, palatina, serif;">方法：</span><ul><li><span style="font-family: georgia, palatina, serif;">HTTP的状态码</span></li><li><span style="font-family: georgia, palatina, serif;">reason：原因</span></li><li><span style="font-family: georgia, palatina, serif;">headers</span></li></ul></li></ul></li></ul><div><br clear="none"/></div><br clear="none"/></div></span>
</div></body></html> 