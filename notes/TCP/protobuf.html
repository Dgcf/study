<html>
<head>
  <title>protobuf</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604043 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="733"/>
<h1>protobuf</h1>

<div>
<span><div><div><h1><a href="https://www.cnblogs.com/mfryf/p/5265123.html" shape="rect" target="_blank">google_protobuf数据类型</a></h1></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><a href="https://www.jianshu.com/p/72108f0aefca">https://www.jianshu.com/p/72108f0aefca</a><br/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><br/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><br/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">要通信，必须有协议，否则双方无法理解对方的码流。在protobuf中，协议是由一系列的消息组成的。因此最重要的就是定义通信时使用到的消息格式。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"><br clear="none"/></div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">正数的补码 = 原码 </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">负数的补码 = {原码符号位不变} + {数值位按位取反后+1}</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">二进制协议：https://www.jianshu.com/p/73c9ed3a4877</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Protobuf消息定义</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">消息由至少一个字段组合而成，类似于C语言中的结构。每个字段都有一定的格式。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">字段格式：限定修饰符① | 数据类型② | 字段名称③ | = | 字段编码值④ | [字段默认值⑤]</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">①．限定修饰符包含 required\optional\repeated</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Required: 表示是一个必须字段，必须相对于发送方，在发送消息之前必须设置该字段的值，对于接收方，必须能够识别该字段的意思。发送之前没有设置required字段或者无法识别required字段都会引发编解码异常，导致消息被丢弃。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Optional：表示是一个可选字段，可选对于发送方，在发送消息时，可以有选择性的设置或者不设置该字段的值。对于接收方，如果能够识别可选字段就进行相应的处理，如果无法识别，则忽略该字段，消息中的其它字段正常处理。---因为optional字段的特性，很多接口在升级版本中都把后来添加的字段都统一的设置为optional字段，这样老的版本无需升级程序也可以正常的与新的软件进行通信，只不过新的字段无法识别而已，因为并不是每个节点都需要新的功能，因此可以做到按需升级和平滑过渡。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Repeated：表示该字段可以包含0~N个元素。其特性和optional一样，但是每一次可以包含多个值。可以看作是在传递一个数组的值。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">②．数据类型</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">Protobuf定义了一套基本数据类型。几乎都可以映射到C++\Java等语言的基础数据类型.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">      </div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">protobuf 数据类型</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">描述</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">打包</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">C++语言映射</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">bool</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">布尔类型</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">1字节</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">bool</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">double</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">64位浮点数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">double</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">float</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">32为浮点数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">float</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">int32</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">32位整数、</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">int</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">uin32</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">无符号32位整数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">unsigned int</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">int64</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">64位整数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">__int64</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">uint64</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">64为无符号整</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">unsigned __int64</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">sint32</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">32位整数，处理负数效率更高</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">int32</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">sing64</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">64位整数 处理负数效率更高</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">__int64</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">fixed32</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">32位无符号整数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">4</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">unsigned int32</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">fixed64</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">64位无符号整数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">8</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">unsigned __int64</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">sfixed32</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">32位整数、能以更高的效率处理负数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">4</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">unsigned int32</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">sfixed64</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">64为整数</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">8</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">unsigned __int64</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">string</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">只能处理 ASCII字符</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">std::string</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">bytes</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">用于处理多字节的语言字符、如中文</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">std::string</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">enum</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">可以包含一个用户自定义的枚举类型uint32</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N(uint32)</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">enum</div></td></tr><tr><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">message</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">可以包含一个用户自定义的消息类型</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N</div></td><td rowspan="1" style="width: 130px; padding: 8px; border: 1px solid;"><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">object of class</div></td></tr></tbody></table><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">N 表示打包的字节并不是固定。而是根据数据的大小或者长度。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">例如int32，如果数值比较小，在0~127时，使用一个字节打包。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于枚举的打包方式和uint32相同。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于message，类似于C语言中的结构包含另外一个结构作为数据成员一样。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于 fixed32 和int32的区别。fixed32的打包效率比int32的效率高，但是使用的空间一般比int32多。因此一个属于时间效率高，一个属于空间效率高。根据项目的实际情况，一般选择fixed32，如果遇到对传输数据量要求比较苛刻的环境，可以选择int32.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">③．字段名称</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">字段名称的命名与C、C++、Java等语言的变量命名方式几乎是相同的。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">protobuf建议字段的命名采用以下划线分割的驼峰式。例如 first_name 而不是firstName.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">④．字段编码值</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">有了该值，通信双方才能互相识别对方的字段。当然相同的编码值，其限定修饰符和数据类型必须相同。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">编码值的取值范围为 1~2^32（4294967296）。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">其中 1~15的编码时间和空间效率都是最高的，编码值越大，其编码的时间和空间效率就越低（相对于1-15），当然一般情况下相邻的2个值编码效率的是相同的，除非2个值恰好实在4字节，12字节，20字节等的临界区。比如15和16.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">1900~2000编码值为Google protobuf 系统内部保留值，建议不要在自己的项目中使用。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">protobuf 还建议把经常要传递的值把其字段编码设置为1-15之间的值。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">消息中的字段的编码值无需连续，只要是合法的，并且不能在同一个消息中有字段包含相同的编码值。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">建议：项目投入运营以后涉及到版本升级时的新增消息字段全部使用optional或者repeated，尽量不实用required。如果使用了required，需要全网统一升级，如果使用optional或者repeated可以平滑升级。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">⑤．默认值。当在传递数据时，对于required数据类型，如果用户没有设置值，则使用默认值传递到对端。当接受数据是，对于optional字段，如果没有接收到optional字段，则设置为默认值。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于import</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">protobuf 接口文件可以像C语言的h文件一个，分离为多个，在需要的时候通过 import导入需要对文件。其行为和C语言的#include或者java的import的行为大致相同。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于package</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">避免名称冲突，可以给每个文件指定一个package名称，对于java解析为java中的包。对于C++则解析为名称空间。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;"> </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于message</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">支持嵌套消息，消息可以包含另一个消息作为其字段。也可以在消息内定义一个新的消息。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">关于enum</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">枚举的定义和C++相同，但是有一些限制。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">枚举值必须大于等于0的整数。</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">使用分号(;)分隔枚举变量而不是C++语言中的逗号(,)</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">eg.</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">enum VoipProtocol </div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">{</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">    H323 = 1;</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">    SIP  = 2;</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">    MGCP = 3;</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">    H248 = 4;</div><div style="margin-top: 1em; margin-bottom: 1em;-en-paragraph:true;">}</div><div><br clear="none"/></div></div><div><br/></div></span>
</div></body></html> 