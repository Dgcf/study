<html>
<head>
  <title>内存诊断工具</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604043 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="727"/>
<h1>内存诊断工具</h1>

<div>
<span><div><div><div><span style="font-weight: bold;">valgrind</span></div><div>安装：ubuntu：sudo apt-get install valgrind</div><div>redhat：yum install valgrind</div><div>使用：</div><ul><li><div>最常用的命令格式：valgrind --tool=memcheck --leak-check=full ./test</div></li><li><div>--tool=&lt;name&gt; 最常用的选项。运行 valgrind中名为toolname的工具。默认memcheck。以下为name：</div></li><ul><li><div>memcheck：这是valgrind应用最广泛的工具，一个重量级的内存检查器，能够发现开发中绝大多数内存错误使用情况，比如：使用未初始化的内存，使用已经释放了的内存，内存访问越界等。</div></li><li><div>callgrind：检查程序中函数调用过程中出现的问题。</div></li><li><div>cachegrind：检查程序中缓存使用出现的问题。</div></li><li><div>helgrind：检查多线程程序中出现的竞争问题。</div></li><li><div>massif：检查程序中堆栈使用中出现的问题。</div></li><li><div>extension：可以利用core提供的功能，自己编写特定的内存调试工具</div></li></ul><li><div>--log-file=&lt;file&gt; 将输出的信息写入到file中</div></li></ul><div>以下是未验证功能：</div><div>    -h –help 显示帮助信息。</div><div>    -version 显示valgrind内核的版本，每个工具都有各自的版本。</div><div>    -q –quiet 安静地运行，只打印错误信息。</div><div>    -v –verbose 更详细的信息, 增加错误数统计。</div><div>    -trace-children=no|yes 跟踪子线程? [no]</div><div>    -track-fds=no|yes 跟踪打开的文件描述？[no]</div><div>    -time-stamp=no|yes 增加时间戳到LOG信息? [no]</div><div>    -log-fd=&lt;number&gt; 输出LOG到描述符文件 [2=stderr]</div><div>    -log-file=&lt;file&gt; 将输出的信息写入到filename.PID的文件里，PID是运行程序的进行ID</div><div>    -log-file-exactly=&lt;file&gt; 输出LOG信息到 file</div><div>    -log-file-qualifier=&lt;VAR&gt; 取得环境变量的值来做为输出信息的文件名。 [none]</div><div>    -log-socket=ipaddr:port 输出LOG到socket ，ipaddr:port</div><div><br/></div><div><br/></div><div>Memcheck将内存泄露分为两种：</div><ul><li><div>一种是可能的内存泄露（Possibly lost）是指仍然存在某个指针能够访问某块内存，但该指针指向的已经不是该内存首地址。</div></li><li><div>另外一种是确定的内存泄露（Definitely lost）是指已经不能够访问这块内存。而Definitely lost又分为两种：</div></li><ul><li><div>直接的（direct）：直接是没有任何指针指向该内存</div></li><li><div>间接的（indirect）：间接是指指向该内存的指针都位于内存泄露处。在上述的例子中，根节点是directly lost，而其他节点是indirectly lost</div></li></ul></ul><div>LOG信息输出</div><div>    -xml=yes 将信息以xml格式输出，只有memcheck可用</div><div>    -num-callers=&lt;number&gt; show &lt;number&gt; callers in stack traces [12]</div><div>    -error-limit=no|yes 如果太多错误，则停止显示新错误? [yes]</div><div>    -error-exitcode=&lt;number&gt; 如果发现错误则返回错误代码 [0=disable]</div><div>    -db-attach=no|yes 当出现错误，valgrind会自动启动调试器gdb。[no]</div><div>    -db-command=&lt;command&gt; 启动调试器的命令行选项[gdb -nw %f %p]</div><div><br/></div><div>适用于Memcheck工具的相关选项：</div><div><br/></div><div>    -leak-check=no|summary|full 要求对leak给出详细信息? [summary]</div><div>    -leak-resolution=low|med|high how much bt merging in leak check [low]</div><div>    -show-reachable=no|yes show reachable blocks in leak check? [no]</div></div><div><br/></div><div>案例分析：</div><ul><li><div>内存读/写错误：</div></li><ul><li><div>提示1：Address 0xxxxxx is x bytes inside/after a block of size 42 alloc'd</div></li><li><div>提示0：Invalid write/read of size xx</div></li><li><div>分析：</div></li><ul><li><div>inside是在申请的内存内，after是在申请的内存外；一般都是读写越界的内存；inside是读写跨越的部分；</div></li><li><div>提示0中的size xx从目前看是对齐/寻址 大小</div></li></ul></ul></ul><div><br/></div><div><span style="font-weight: bold;">AddressSanitizer</span>用法。从gcc4.8开始，AddressSanitizer成为gcc的一部分</div><div>用法：</div><ul><li><div>-fsanitize=address：编译和链接程序</div></li><li><div>-fno-omit-frame-pointer编译，以得到更容易理解的stack trace</div></li><li><div>可选择-O1或更高的优化级别编译</div></li></ul><div><br/></div></div><div style="margin: 10px auto; text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">Ubuntu 一般不用安装，CentOS 一般需要安装。</span></div><div style="margin: 10px auto; text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">如果使用 AddressSanitizer 时报错：</span></div><div style="margin-top: 0px; margin-bottom: 0px; color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">/usr/bin/ld: cannot find /usr/lib64/libasan.so.0.0.0</span></div><div style="margin: 10px auto; text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">则需要先安装。Ubuntu 安装命令：</span></div><div style="margin-top: 0px; margin-bottom: 0px; color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; line-height: 19.5px;">sudo</span> <span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; line-height: 19.5px;">apt-get</span> <span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; line-height: 19.5px;">install</span> <span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">libasan0</span></div><div style="margin: 10px auto; text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="text-indent: 0px; color: rgb(0, 0, 0); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">CentOS 安装命令：</span></div><div style="margin-top: 0px; margin-bottom: 0px; color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; line-height: 19.5px;">sudo</span> <span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">yum</span> <span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; line-height: 19.5px;">install</span> <span style="color: rgb(0, 0, 0); font-size: 13px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">libasan</span></div><div><br/></div></span>
</div></body></html> 